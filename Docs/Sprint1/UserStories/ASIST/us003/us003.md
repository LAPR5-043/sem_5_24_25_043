#  As a system administrator I want to implement quota management on the Linux system so that users can't exceed 300 files on their home directory.

For this User Storie, we would tipically use a common approach which would be to use the commands `edquota` and `setquota` for implementing a quota for the users in the system.

In this case it is required a quota management for all users in the system individually and not in a group.

For this case we could create a script file to run and to apply a default quota for all users in the system with the commands refered above but we still would have to run these script every time a user was added creating a need to automate the process, because the quota management should be applied to all users in the system, **including the ones that could be created in the future**.

After searching, we found an alternative solution that is more simple and effective and we decided to implement it.

In Linux, `pam_setquota` is a PAM(Pluggable Authentication Modules) module to set or modify disk quotas on session start.

## Steps to implement quota management on the Linux system 

### **1. Check if quotas are activated on the filesystem**

Check if quotas are activated in the /home filesystem.

    cat /etc/fstab 

In the file it shows this line, which confirms that quotas are activated in /home filesystem.

    # /home was on /dev/sda3 during installation
    UUID=0ad60295-48c2-4ed0-8de8-c964f1a38367 /home           ext4    defaults,usrquota,grpquota        0       2


### **2. Check if quotas are enabled**
Check if the files aquota.group and aquota.user were already created.

    root@debian:/# cd /home/
    root@debian:/home# ls | grep aquota
    aquota.group  
    aquota.user

Check if quotas are enabled with the command `repquota /home` to show all the quotas enabled in the filesystem(/home).

    *** Report for user quotas on device /dev/sda3
    Block grace time: 7days; Inode grace time: 7days

                            Block limits                File limits
    User            used    soft    hard  grace    used  soft  hard  grace
    ----------------------------------------------------------------------
    root      --      24       0       0              3     0     0       
    asist     --      68       0       0             13   290   300       
    luser1    --       8       0       0              2   290   300       
    luser2    --       4       0       0              1   290   300       
    luser3    --      16       0       0              4   290   300       
    luser4    --       4       0       0              1     0     0       
    luser5    --       4       0       0              1     0     0       
    luser6    --       4       0       0              1     0     0       
    testuser1 --      16       0       0              4     0     0       
    testuser2 --      16       0       0              4     0     0       
    testuser3 --      16       0       0              4     0     0       
    testuser4 --      16       0       0              4     0     0       
    SLB       --      16       0       0              4     0     0       
    finaltest --      16       0       0              4     0     0       
    darwin    --      16       0       0              4     0     0       
    darwin2   --      16       0       0              4   290   300       
    #1002     --      32       0       0              8     0     0       
    #8003     --      16       0       0              4     0     0 


### **3. Check if the module is installed**
We check if the PAM module `pam_setquota.so` is installed in the system.

    root@debian:~# cd /lib/x86_64-linux-gnu/security
    root@debian:/lib/x86_64-linux-gnu/security# ls | grep pam_setquota
    pam_setquota.so

### **4. Edit the PAM configuration file**

This PAM configuration file is responsible for specifying the actions that should be taken during a user's session.

    nano /etc/pam.d/common-session

### **5. Add the `pam_setquota.so` configuration line**

There are 9 parameters for the configuration line of this module:

- `fs=/home`

    The device file or mountpoint the policy applies to. Defaults to the filesystem containing the users home directory.

- `overwrite=0`

    Overwrite an existing quota. Note: Enabling this will remove the ability for the admin to manually configure different quotas for users for a filesystem with edquota(8). (Defaults to 0)

- `debug=0`

    Enable debugging. A value of 1 outputs the old and new quota on a device. A value of 2 also prints out the matched and found filesystems should fs be unset. (Defaults to 0)

- `startuid=1000`

    Describe the start of the UID range the policy is applied to. (Defaults to UID_MIN from login.defs or the uidmin value defined at compile-time if UID_MIN is undefined.)

- `enduid=0`

    Describe the end of the UID range the policy is applied to. Setting enduid=0 results in an open-ended UID range (i.e. all uids greater than startuid are included). (Defaults to 0)

- `bsoftlimit=19000`

    Soft limit for disk quota blocks, as defined by quotactl(2). Note: bsoftlimit and bhardlimit must be set at the same time!

- `bhardlimit=20000`

    Hard limit for disk quota blocks, as defined by quotactl(2). Note: bsoftlimit and bhardlimit must be set at the same time!

- `isoftlimit=3000`

    Soft limit for inodes, as defined by quotactl(2). Note: isoftlimit and ihardlimit must be set at the same time!

- `ihardlimit=4000`

    Hard limit for inodes, as defined by quotactl(2). Note: isoftlimit and ihardlimit must be set at the same time!

For this conditioning access, we need to define:

- the paramter `overwrite` to `1` value, which will make the system overwrite an existing quota, in case it was already implemented with other limit values.

- the paramter `isoftlimit` to `290` value, in order to define a soft number of objects, which in this case was defined by us.

- the parater `ihardlimit` to `300`, in order to define a hard number of objects, which in this case the requested was that users can't exceed 300 files on their home directory.

- the paramter `fs`to `/home`, in order to specifie the mountpoint the policy applies to (/home filesystem).

**Configuration Line:**

    session    required     pam_setquota.so overwrite=1 isoftlimit=290 ihardlimit=300  fs=/home



### **6. Test the quota management**

This implementation was tested for every single user of the system but for demonstartion purposes we will only show an example for a single user(`asist` user).

#### Via SSH
Check the quota implementation in /home:

    repquota /home

    Report for user quotas on device /dev/sda3
    Block grace time: 7days; Inode grace time: 7days
                            Block limits                File limits
    User            used    soft    hard  grace    used  soft  hard  grace
    ----------------------------------------------------------------------
    root      --      24       0       0              3     0     0       
    asist     --      68       0       0             13     0     0     

Then log in via ssh with the asist user:

    ssh asist@10.9.10.43
    asist@debian:~$

Check the quotas and confirm the quota implementation:

    repquota /home

    *** Report for user quotas on device /dev/sda3
    Block grace time: 7days; Inode grace time: 7days
                            Block limits                File limits
    User            used    soft    hard  grace    used  soft  hard  grace
    ----------------------------------------------------------------------
    root      --      24       0       0              3     0     0       
    asist     --      68       0       0             13   290   300     

#### Locally

Check the quota implementation in /home:

    repquota /home

    Report for user quotas on device /dev/sda3
    Block grace time: 7days; Inode grace time: 7days
                            Block limits                File limits
    User            used    soft    hard  grace    used  soft  hard  grace
    ----------------------------------------------------------------------
    root      --      24       0       0              3     0     0       
    asist     --      68       0       0             13     0     0  

Then log in locally with the asist user:

    root@debian:~# su asist
    asist@debian:/root$ 

Check the quotas and confirm the quota implementation:

    repquota /home
    *** Report for user quotas on device /dev/sda3
    Block grace time: 7days; Inode grace time: 7days
                            Block limits                File limits
    User            used    soft    hard  grace    used  soft  hard  grace
    ----------------------------------------------------------------------
    root      --      24       0       0              3     0     0       
    asist     --      68       0       0             13   290   300  