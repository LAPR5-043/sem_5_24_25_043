# US 005 - Administração de Sistemas

## 1. Context

*Explain the context for this task. It is the first time the task is assigned to be developed or this tasks was incomplete in a previous sprint and is to be completed in this sprint? Are we fixing some bug?*

## 2. Requirements


**US ASIST-005** Como administrador do sistema quero usar no sistema Linux o módulo PAM “pam_succeed_if.so” para condicionar o acesso ao sistema, permitindo acesso apenas aos utilizadores com UID inferior a 7000 e que pertençam ao grupo lasistgrupo.

**Acceptance Criteria:**

- ASIST-005.1. The system shall use the PAM module "pam_succeed_if.so" to condition access to the system.
- ASIST-005.2. The system shall only allow access to users with UID less than 7000.
- ASIST-005.3. The system shall only allow access to users who belong to the group lasistgrupo.

**Dependencies/References:**

*N/A*

## 3. Analysis

### 3.1. Requirement

The system shall use the PAM module "pam_succeed_if.so" to condition access to the system. The system shall only allow access to users with UID less than 7000. The system shall also only allow access to users who belong to the group lasistgrupo.

### 3.2. Research

Information about the PAM module "pam_succeed_if.so" manual page can be found [here](https://linux.die.net/man/8/pam_succeed_if).

**Name**

`pam_succeed_if` - test account characteristics

**Synopsis**

`pam_succeed_if.so [flag...] [condition...]`

**Description**

`pam_succeed_if.so` is designed to succeed or fail authentication based on characteristics of the account belonging to the user being authenticated. One use is to select whether to load other modules based on this test.

The module should be given one or more conditions as module arguments, and authentication will succeed only if all of the conditions are met.

**Options**

- **debug**: Turns on debugging messages sent to syslog.
- **use_uid**: Evaluate conditions using the account of the user whose UID the application is running under instead of the user being authenticated.
- **quiet**: Don't log failure or success to the system log.
- **quiet_fail**: Don't log failure to the system log.
- **quiet_success**: Don't log success to the system log.


**Relevant Fields For This Feature**

- **field < number**: Field has a value numerically less than number.
- **user ingroup group**: User is in given group.

### 3.3 Which PAM file to edit?

We have 3 files that can be edited to configure PAM:

- **/etc/pam.d/sshd**: This file is used to configure the PAM module for the SSH service.
- **/etc/pam.d/common-auth**: This file has the authentication settings common to all services
- **/etc/pam.d/login**: This file is used to configure the PAM module for the login service.

### 3.4. Decision

Based on the requirement, and as SSH is not referenced in the user story and it was mentioned to access the system, it was decided to use the `/etc/pam.d/common-auth` file to configure the PAM module, as it has the authentication settings common to all services, including all possible services that require authentication.


## 4. Implementation

### 4.1. Edit the `/etc/pam.d/common-auth` file

First, we need to edit the `/etc/pam.d/common-auth` file to add the `pam_succeed_if.so` module.

```bash

nano /etc/pam.d/common-auth

```

### 4.2 Add the rule to the `/etc/pam.d/common-auth` file

```bash

auth [success=1 default=ignore] pam_succeed_if.so uid = 0 # Ensure that rule does not apply to root
auth required pam_succeed_if.so uid < 7000 user ingroup lasistgrupo

```

### 4.3. Test the configuration


To test the configuration, we create 2 different groups:

```bash
sudo groupadd lasistgrupo
sudo groupadd faillastgrupo
```

Then we create 4 test users:

**testuser1** - User with correct UID but not in the group:

```bash
sudo useradd -m -u 6010 -G faillastgrupo testuser1
sudo passwd testuser1 # Password: testuser1
```

**testuser2** - User with incorrect UID and not in the group:

```bash
sudo useradd -m -u 8000 -G faillastgrupo testuser2
sudo passwd testuser2 # Password: testuser2
```

**testuser3** - User with incorrect UID but in the group:

```bash
sudo useradd -m -u 8001 -G lasistgrupo testuser3
sudo passwd testuser3 # Password: testuser3
```

**testuser4** - User with correct UID and in the group, this user should be able to login:

```bash
sudo useradd -m -u 6011 -G lasistgrupo testuser4
sudo passwd testuser4  # Password: testuser4
```


### 4.4. Expected Results

- **testuser1**: User with correct UID but not in the group, should not be able to login.
- **testuser2**: User with incorrect UID and not in the group, should not be able to login.
- **testuser3**: User with incorrect UID but in the group, should not be able to login.
- **testuser4**: User with correct UID and in the group, should be able to login.

### 4.5. Results

**testuser1**:

```bash
su - testuser1
```

**Result**: Authentication failure

```bash
asist@debian:~$ su testuser1
Password:
su: Authentication failure
```

**testuser2**:

```bash
su - testuser2
```

**Result**: Authentication failure

```bash
asist@debian:~$ su testuser2
Password:
su: Authentication failure
```

**testuser3**:

```bash
su - testuser3
```

**Result**: Authentication failure

```bash
asist@debian:~$ su testuser3
Password:
su: Authentication failure
```

**testuser4**:

```bash
su - testuser4
```

**Result**: Authentication successful

```bash
asist@debian:~$ su testuser4
Password:
$
$ id
uid=6011(testuser4) gid=6011(testuser4) groups=6011(testuser4),6006(lasistgrupo)
$
```

### 4.6. Conclusion

The configuration was successful, the users were able to login according to the expected results.


## 5. Integration/Demonstration

Demonstration of the feature can be seen on the previous section, when the test users were created and tested.

## 6. Observations

*N/A*