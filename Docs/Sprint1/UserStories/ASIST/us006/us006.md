# As the system administrator I want to use the PAM module "pam_listfile.so" on the Linux system to condition access to the system, allowing access only to the remote machines (one per line) that are in the file (that must be created) /etc/remote-hosts.

In Linux, `pam_listfile` is a PAM(Pluggable Authentication Modules) module which provides a way to deny or allow services based on an arbitrary file.

## Steps to allow access only to remote machines specified in the file /etc/remote-hosts

### **1. Create the /etc/remote-hosts file**

Create the file `/etc/remote-hosts` with the IPs of the machines that we want to allow the remote access to.

    touch /etc/remote-hosts

In this case, we created a linux virtual machine in the DEI cloud with a static ipv4 automatically configured during the creation process (10.9.24.205) which allowed us to test the conditioning acess.
    
    nano /etc/remote-hosts


####  File /etc/remote-hosts content 

    10.9.24.205

Note: This approach was useful because it allowed us to test the User Storie in a safe way because every time we connect to the DEI VPN it configures the IP in our host with a DHCP service, which doesn't guarantee that every time we connect to the VPN, the IP configured in our host will always be the same. With this approach we have the guarantee that the IP will always be the same.

### **2. Edit the PAM Configuration File**

The PAM configuration for the Secure Shell service is in the `/etc/pam.d/sshd` file.  

    nano /etc/pam.d/sshd

### **3. Add the `pam_listfile.so` configuration line**

There are 6 parameters for the configuration line of this module :

- `item=[tty|user|rhost|ruser|group|shell]`
    
    What is listed in the file and should be checked for.

- `sense=[allow|deny]`

    Action to take if found in file, if the item is NOT found in the file, then the opposite action is requested.

- `file=/path/filename`
    
    File containing one item per line. The file needs to be a plain file and not world writable.

- `onerr=[succeed|fail]`
    
    What to do if something weird happens like being unable to open the file.

- `apply=[user|@group]`
    
    Restrict the user class for which the restriction apply. Note that with item=[user|ruser|group] this does not make sense, but for item=[tty|rhost|shell] it have a meaning.

- `quiet`
    
    Do not treat service refusals or missing list files as errors that need to be logged.

For this conditioning access, we need to define:

- the paramter `onerr` to `fail` value, in case it can't open the file.

- the paramter `item` to `rhost` value, in order to define a specific host (IP) to allow the access to.

- the parater `sense` to `allow`, in order to allow the acess to the host specified in the file.

- the paramter `file`to `/etc/remote-hosts`, in order to specifie the file which will specifie the host to which it will be allowed the access to.

#### Configuration line in `/etc/pam.d/sshd` 

    auth required pam_listfile.so onerr=fail item=rhost sense=allow file=/etc/remote-hosts

### **4. Restart SSH service**

After configuring the PAM module, we need to restart the ssh service, in order to apply the changes.

    systemctl restart ssh



### **5. Test the conditioning access**

Log in to our virtual machine created in the DEI Cloud (10.9.24.205):

    ssh root@vs1229.dei.isep.ipp.pt

Prompt the command to access the system remotely via SSH:

    root@vs1229:~# ssh root@10.9.10.43

Successfully log in:

    root@debian:~# 


In our host machine( IP: 10.8.137.45 ), the module won't let us access remotely the system.  

    root@10.9.10.43's password: 
    Permission denied, please try again.