@startuml


title US 5.1.3 - As a Patient, I want to self-register so that I can use the application

skinparam classAttributeIconSize 0

skinparam class {
    LifeLineBorderColor DodgerBlue
    LifeLineBackgroundColor APPLICATION
    BackgroundColor LemonChiffon
    ArrowColor Brown
    BorderColor SaddleBrown
}

skinparam packageStyle rectangle

skinparam card {
    LifeLineBorderColor DodgerBlue
    LifeLineBackgroundColor APPLICATION
    BackgroundColor LemonChiffon
    ArrowColor Brown
    BorderColor SaddleBrown
}

actor "Patient" as P

participant "Route" as Route
participant ":UserController" as UC
participant ":PatientService" as PS
participant ":PatientRepository" as PR
participant ":AuthService" as AS
participant "External IAM Provider" as IAM
participant ":EmailService" as ES

activate P

P -> Route: /api/User/signup-patient

activate Route

Route -> UC: SignUpPatientAsync(email, password, ...)

activate UC

UC -> PS: SignUpNewPatientIamAsync(email, password, ...)

activate PS

PS -> PR: patientExists(email)

activate PR

PR --> PS: result

deactivate PR

alt "Patient not found"

    PS --> UC: false

    UC --> Route: false

    Route --> P: returns "Patient not found"

else "Patient found"

    PS --> AS: RegisterNewPatientAsync(email, password, ...)

    activate AS

    AS -> IAM: AdminCreateUserAsync(signUpRequest)

    activate IAM

    IAM --> AS:

    deactivate IAM

    AS -> ES: sendConfirmationEmail(patientEmail)

    activate ES

    ES --> AS: 

    deactivate ES

    AS --> PS: true

    deactivate AS

    PS --> UC: true

    deactivate PS

    UC --> Route: true

    deactivate UC

    Route --> P: returns "User Registered, check your email"

end















@enduml